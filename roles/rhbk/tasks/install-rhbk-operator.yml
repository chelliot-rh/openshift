- name: Create Keycloak DB Secret
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: keycloak-db-secret
        namespace: "{{ name_space }}"
      type: Opaque
      stringData:
        username: "{{ rhbk_admin_user }}"
        password: "{{ rhbk_admin_password }}"

- name: Create Keycloak ADMIN Secret
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: keycloak-admin-creds
        namespace: "{{ name_space }}"
      type: Opaque
      stringData:
        username: "{{ rhbk_admin_user }}"
        password: "{{ rhbk_admin_password }}"

- name: Create Keycloak TLS Secret
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: keycloak-tls-secret
        namespace: "{{ name_space }}"
      type: kubernetes.io/tls
      data:
        tls.crt: "{{ tls_crt | b64encode }}"
        tls.key: "{{ tls_key | b64encode }}"

- name: Deploy PostgreSQL StatefulSet
  kubernetes.core.k8s:
    definition:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgresql-db
        namespace: "{{ name_space }}"
      spec:
        serviceName: postgres-db
        selector:
          matchLabels:
            app: postgresql-db
        replicas: 1
        template:
          metadata:
            labels:
              app: postgresql-db
          spec:
            containers:
              - name: postgresql-db
                image: "{{ postgres_image | default('registry.redhat.io/rhel9/postgresql-15:latest') }}"
                ports:
                  - containerPort: 5432
                volumeMounts:
                  - name: data-volume
                    mountPath: /var/lib/pgsql/data
                env:
                  - name: POSTGRESQL_USER
                    valueFrom:
                      secretKeyRef:
                        name: keycloak-db-secret
                        key: username
                  - name: POSTGRESQL_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: keycloak-db-secret
                        key: password
                  - name: POSTGRESQL_DATABASE
                    value: keycloak
                  - name: POSTGRES_DB
                    value: keycloak
        volumeClaimTemplates:
          - metadata:
              name: data-volume
            spec:
              accessModes: ['ReadWriteOnce']
              resources:
                requests:
                  storage: 10Gi
              storageClassName: "{{ storage }}"

- name: Deploy PostgreSQL Service
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres-db
        namespace: "{{ name_space }}"
      spec:
        selector:
          app: postgresql-db
        type: ClusterIP
        ports:
          - port: 5432
            targetPort: 5432

- name: Deploy Keycloak Custom Resource
  kubernetes.core.k8s:
    definition:
      apiVersion: k8s.keycloak.org/v2alpha1
      kind: Keycloak
      metadata:
        name: keycloak
        namespace: "{{ name_space }}"
      spec:
        instances: 1
        db:
          vendor: postgres
          host: postgres-db
          usernameSecret:
            name: keycloak-db-secret
            key: username
          passwordSecret:
            name: keycloak-db-secret
            key: password
        http:
          tlsSecret: keycloak-tls-secret
        hostname:
          hostname: "{{ rhbk_hostname }}"
        proxy:
          headers: xforwarded
